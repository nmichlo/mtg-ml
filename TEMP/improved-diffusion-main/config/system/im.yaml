
system_cls:
  _target_: improved_diffusion.train_util.IDDPM
  _recursive_: False

  lr: 1e-4
  lr_anneal_steps: NULL
  weight_decay: 0.0
  ewm_rate: 0.9999

  cfg_model:
    _target_: improved_diffusion.script_util.ImageModelCfg
    # both
    learn_sigma: False
    # model
    image_size: 64
    # small_size: N/A
    num_channels: 128
    num_res_blocks: 2
    num_heads: 4
    num_heads_upsample: -1
    channel_mult: ${system.computed.channel_mult}
    attention_resolutions: "16,8"
    dropout: 0.0
    num_classes: NULL  # [int] (was: class_cond=False -> NULL, class_cond=True -> 1000, num classes in dataset)
    use_checkpoint: False
    use_scale_shift_norm: True

  cfg_diffusion_and_sample:
    _target_: improved_diffusion.script_util.DiffusionAndSampleCfg
    # both
    learn_sigma: False
    # diffusion
    diffusion_steps: 1000
    sigma_small: False
    noise_schedule: "linear"
    use_kl: False
    predict_xstart: False
    rescale_timesteps: True       # might actually be false?
    rescale_learned_sigmas: True  # might actually be false?
    timestep_respacing: ""
    # schedule sampler
    schedule_sampler: "uniform"

datamodule_cls:
  _target_: mtg_ml.util.ptl.Hdf5DataModule
  _recursive_: False
  # CONFIG
  h5_path: '${oc.env:HOME}/workspace/playground/mtg-dataset/data/mtg_default-cards-20211128100240_normal_65903x64x46x3_c4.h5'
  h5_dataset_name: 'data'
  batch_size: 1 # ${settings.data.batch_size}
  val_ratio: 0.0
  num_workers: 4
  in_memory: FALSE
  transform:
    _target_: mtg_ml.util.transforms.ToStandardF32
    size: NULL
    mean: 0.5 # ${data.meta.img_mean}
    std: 0.5 # ${data.meta.img_std}
    pad_to_square: TRUE


computed:
  channel_mult: ${system.computed._channel_mults.${system.computed._im_size}}
  # private vals
  _im_size: "s${system.system_cls.cfg_model.image_size}"
  _channel_mults:
    s256: [1, 1, 2, 2, 4, 4]
    s64:  [1, 2, 3, 4]
    s32:  [1, 2, 2, 2]


trainer:
  _target_: pytorch_lightning.Trainer

  max_steps: ${system.system_cls.lr_anneal_steps}
  gpus: [1]

  callbacks:
    - _target_: improved_diffusion.train_util.IddpmVisualiseCallback
      name: 'iddpm_online'
      every_n_steps: 2000
      mean_std: [0.5, 0.5]
      save_dir: 'data'
      sample_kwargs:
        online: True
    - _target_: improved_diffusion.train_util.IddpmVisualiseCallback
      name: 'iddpm_target'
      every_n_steps: 2000
      mean_std: [0.5, 0.5]
      save_dir: 'data'
      sample_kwargs:
        online: False
